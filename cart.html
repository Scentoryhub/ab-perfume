<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Your Cart</title>
    <link rel="icon" type="image/png" href="icon/32.png" />
    <link rel="apple-touch-icon" href="icon/180.png" />

    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-ZKERETN8Y2"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-ZKERETN8Y2", {
        custom_map: { dimension1: "client_id" },
      });
      gtag("get", "G-ZKERETN8Y2", "client_id", (clientID) => {
        localStorage.setItem("ga_client_id", clientID);
      });
    </script>

    <script>
      !(function (f, b, e, v, n, t, s) {
        if (f.fbq) return;
        n = f.fbq = function () {
          n.callMethod
            ? n.callMethod.apply(n, arguments)
            : n.queue.push(arguments);
        };
        if (!f._fbq) f._fbq = n;
        n.push = n;
        n.loaded = !0;
        n.version = "2.0";
        n.queue = [];
        t = b.createElement(e);
        t.async = !0;
        t.src = v;
        s = b.getElementsByTagName(e)[0];
        s.parentNode.insertBefore(t, s);
      })(
        window,
        document,
        "script",
        "https://connect.facebook.net/en_US/fbevents.js"
      );
      fbq("init", "9083739771684521");
      fbq("track", "PageView");
    </script>
    <noscript
      ><img
        height="1"
        width="1"
        style="display: none"
        src="https://www.facebook.com/tr?id=9083739771684521&ev=PageView&noscript=1"
    /></noscript>
    <style>
      /* Reset and common styles */
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        padding: 0;
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        background: #f4f4f4;
        color: #111;
        -webkit-font-smoothing: antialiased;
        padding-bottom: 120px; /* Space for footer actions */
      }
      .page-header {
        position: relative;
        text-align: center;
        padding: 20px 15px;
        border-bottom: 1px solid #eee;
        background-color: #fff;
        margin-bottom: 20px;
      }
      .page-header h1 {
        margin: 0;
        font-size: 1.8rem;
        font-weight: 700;
        color: #222;
      }
      .back-btn {
        position: absolute;
        top: 50%;
        left: 15px;
        transform: translateY(-50%);
        width: 30px;
        height: 30px;
        cursor: pointer;
        background-image: url("icon/back.png");
        background-size: contain;
        background-repeat: no-repeat;
      }

      #capture-area {
        max-width: 1200px;
        margin: 0 auto;
        padding: 15px;
      }

      .cart-items-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        grid-template-columns: 1fr;
        gap: 15px;
      }
      @media (min-width: 768px) {
        .cart-items-list {
          grid-template-columns: 1fr 1fr;
        }
      }

      .cart-item {
        display: flex;
        align-items: center;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        overflow: hidden;
        gap: 15px;
        padding-right: 15px;
      }
      .cart-item img {
        width: 80px;
        height: 80px;
        object-fit: cover;
        flex-shrink: 0;
        transition: width 0.3s, height 0.3s;
      }
      @media (min-width: 600px) {
        .cart-item img {
          width: 120px;
          height: 120px;
        }
      }

      .item-details {
        flex-grow: 1;
        padding: 15px 0;
      }
      /* ÂìÅÁâåÂêçÊ†∑Âºè‰ºòÂåñÔºöÂä†Á≤ó„ÄÅÂ§ßÂè∑ */
      .item-details h3 {
        margin: 0 0 5px 0;
        font-size: 1.2rem;
        color: #222;
        font-weight: 800;
      }

      .quantity-control {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 5px;
      }
      .quantity-control button {
        background: #f0f0f0;
        border: 1px solid #ccc;
        border-radius: 50%;
        width: 25px;
        height: 25px;
        cursor: pointer;
      }
      .remove-btn {
        padding: 6px 10px;
        background: #eee;
        color: #777;
        border: 1px solid #ddd;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.8rem;
        margin-left: auto;
      }

      /* Discount Tiers Visualization */
      .discount-tiers-container {
        margin: 20px 0;
        padding: 20px;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        border: 1px solid #e0e0e0;
      }
      .discount-tiers-container h3 {
        margin: 0 0 15px 0;
        text-align: center;
        font-size: 1.3rem;
      }
      #tiers-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 10px;
        font-size: 0.9rem;
      }
      .tier-item {
        padding: 10px;
        border: 1px solid #eee;
        border-radius: 6px;
        background-color: #f9f9f9;
        text-align: center;
      }
      .tier-item.current-tier {
        background-color: #d4edda;
        border-color: #c3e6cb;
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      .tier-discount {
        font-weight: bold;
        color: #28a745;
        display: block;
      }

      .cart-summary {
        margin: 20px 0 0 0;
        padding: 20px;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        border: 1px solid #e0e0e0;
      }
      .cart-summary p {
        display: flex;
        justify-content: space-between;
        margin: 8px 0;
        font-size: 1.1rem;
      }
      .total-count {
        font-weight: bold;
        font-size: 1.2rem;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #eee;
      }

      .cart-actions {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background-color: #fff;
        padding: 15px;
        display: flex;
        justify-content: center;
        gap: 10px;
        border-top: 1px solid #eee;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        z-index: 10;
      }
      .cart-actions button {
        padding: 12px 15px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: bold;
        flex-grow: 1;
        max-width: 220px;
      }
      .clear-cart-btn {
        background-color: #e7e7e7;
        color: #555;
      }
      .send-whatsapp-btn {
        background-color: #25d366;
        color: white;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      /* Modal Styles */
      .checkout-modal {
        display: none;
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        align-items: center;
        justify-content: center;
      }
      .checkout-modal.open {
        display: flex;
      }
      .checkout-container {
        background: #fff;
        width: 90%;
        max-width: 500px;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        max-height: 90vh;
        overflow-y: auto;
      }
      .form-group {
        margin-bottom: 15px;
        text-align: left;
      }
      .form-group label {
        display: block;
        font-weight: bold;
        margin-bottom: 5px;
        font-size: 0.9rem;
      }
      .form-group input,
      .form-group textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 1rem;
      }
      .checkout-btn-group {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }
      .cancel-btn {
        flex: 1;
        background: #eee;
        border: none;
        padding: 12px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
      }
      .confirm-btn {
        flex: 2;
        background: #25d366;
        color: white;
        border: none;
        padding: 12px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
      }

      .empty-cart-message {
        text-align: center;
        color: #777;
        font-size: 1.1rem;
        padding: 50px 0;
      }
    </style>
  </head>
  <body>
    <header class="page-header">
      <a href="index.html" class="back-btn" aria-label="Go back"></a>
      <h1>Your Cart</h1>
    </header>

    <div id="capture-area">
      <ul id="cart-items-list" class="cart-items-list"></ul>

      <div
        id="discount-tiers"
        class="discount-tiers-container"
        style="display: none"
      >
        <h3>Volume Discounts</h3>
        <div id="tiers-list"></div>
      </div>

      <div id="cart-summary" class="cart-summary">
        <h2>Order Summary</h2>
        <p><span>Total Quantity:</span> <span id="total-count">0</span></p>
        <p><span>Subtotal:</span> <span id="subtotal-price">$0.00</span></p>
        <p style="color: #28a745">
          <span>Volume Discount:</span> <span id="discount-amount">-$0.00</span>
        </p>
        <p class="total-count">
          <span>Total Price:</span> <span id="total-price">$0.00</span>
        </p>
      </div>
    </div>

    <div class="cart-actions">
      <button id="clear-cart-btn" class="clear-cart-btn">Clear Cart</button>
      <button id="send-whatsapp-btn" class="send-whatsapp-btn">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 90 90"
          width="18"
          height="18"
          style="fill: currentColor"
        >
          <path
            d="M90,43.841c0,24.213-19.779,43.841-44.182,43.841c-7.747,0-15.025-1.98-21.357-5.455L0,90l7.975-23.522   c-4.023-6.606-6.34-14.354-6.34-22.637C1.635,19.628,21.416,0,45.818,0C70.223,0,90,19.628,90,43.841z M45.818,6.982   c-20.484,0-37.146,16.535-37.146,36.859c0,8.065,2.629,15.534,7.076,21.61L11.107,79.14l14.275-4.537   c5.865,3.851,12.891,6.097,20.437,6.097c20.481,0,37.146-16.533,37.146-36.857S66.301,6.982,45.818,6.982z M68.129,53.938   c-0.273-0.447-0.994-0.717-2.076-1.254c-1.084-0.537-6.41-3.138-7.4-3.495c-0.993-0.358-1.714-0.538-2.438,0.537   c-0.721,1.076-2.797,3.495-3.43,4.212c-0.632,0.719-1.263,0.809-2.347,0.271c-1.082-0.537-4.571-1.673-8.708-5.333   c-3.219-2.848-5.393-6.364-6.025-7.441c-0.631-1.075-0.066-1.656,0.475-2.191c0.488-0.482,1.084-1.255,1.625-1.882   c0.543-0.628,0.723-1.075,1.082-1.793c0.363-0.717,0.182-1.344-0.09-1.883c-0.27-0.537-2.438-5.825-3.34-8.001   c-0.877-2.129-1.758-1.839-2.438-1.839c-0.631,0-1.354-0.09-2.076-0.09c-0.722,0-1.896,0.269-2.889,1.344   c-0.992,1.076-3.789,3.676-3.789,8.963c0,5.288,3.879,10.397,4.422,11.113c0.541,0.716,7.49,11.381,18.17,15.996   c7.31,3.199,9.75,2.56,11.5,2.379c2.471-0.252,6.41-2.604,7.31-5.187C68.4,55.619,68.4,54.386,68.129,53.938z"
          />
        </svg>
        <span>Make Order Now</span>
      </button>
    </div>

    <div id="checkout-modal" class="checkout-modal">
      <div class="checkout-container">
        <div
          style="
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
          "
        >
          <h2 style="margin: 0">Shipping Details</h2>
          <p style="color: #666; font-size: 0.9rem">
            Please enter your address to calculate shipping.
          </p>
        </div>

        <form id="checkout-form">
          <div class="form-group">
            <label>Full Name *</label>
            <input type="text" id="cust-name" placeholder="John Doe" required />
          </div>

          <div class="form-group">
            <label>Email Address *</label>
            <input
              type="email"
              id="cust-email"
              placeholder="john@example.com"
              required
            />
          </div>

          <div class="form-group">
            <label>Street Address *</label>
            <textarea
              id="cust-address"
              rows="2"
              placeholder="123 Main St"
              required
            ></textarea>
          </div>

          <div style="display: flex; gap: 10px">
            <div class="form-group" style="flex: 1">
              <label>City *</label>
              <input type="text" id="cust-city" required />
            </div>
            <div class="form-group" style="flex: 1">
              <label>Zip Code *</label>
              <input type="text" id="cust-zip" required />
            </div>
          </div>

          <div class="checkout-btn-group">
            <button type="button" class="cancel-btn" id="close-checkout">
              Cancel
            </button>
            <button type="submit" class="confirm-btn">Confirm & Send</button>
          </div>
        </form>
      </div>
    </div>

    <script src="db.js"></script>
    <script>
      // --- Logic ---
      const cartItemsList = document.getElementById("cart-items-list");
      const clearCartBtn = document.getElementById("clear-cart-btn");
      const sendWhatsappBtn = document.getElementById("send-whatsapp-btn");

      const totalCountEl = document.getElementById("total-count");
      const subtotalPriceEl = document.getElementById("subtotal-price");
      const discountAmountEl = document.getElementById("discount-amount");
      const totalPriceEl = document.getElementById("total-price");
      const tiersListEl = document.getElementById("tiers-list");
      const discountTiersContainer = document.getElementById("discount-tiers");

      const checkoutModal = document.getElementById("checkout-modal");
      const checkoutForm = document.getElementById("checkout-form");
      const closeCheckoutBtn = document.getElementById("close-checkout");

      const whatsappNumber = "16232027321";

      // Tiers Definition
      const tiers = [
        { min: 1, max: 1, percent: 0 },
        { min: 2, max: 2, percent: 0.03 },
        { min: 3, max: 4, percent: 0.05 },
        { min: 5, max: 9, percent: 0.08 },
        { min: 10, max: 19, percent: 0.14 },
        { min: 20, max: 29, percent: 0.24 },
        { min: 30, max: 49, percent: 0.26 },
        { min: 50, max: 79, percent: 0.29 },
        { min: 80, max: 100, percent: 0.32 },
        { min: 101, max: Infinity, percent: 0.35 },
      ];

      function loadCartFromLocalStorage() {
        const storedCart = localStorage.getItem("perfumeCart");
        return storedCart ? JSON.parse(storedCart) : [];
      }
      function saveCartToLocalStorage(cart) {
        localStorage.setItem("perfumeCart", JSON.stringify(cart));
      }

      function getShortCaption(fullCaption) {
        return fullCaption.split(" - ").slice(0, 2).join(" - ");
      }

      // Render Discount Tiers (Green Boxes)
      function renderDiscountTiers(currentQty) {
        if (!tiersListEl) return;
        tiersListEl.innerHTML = "";

        tiers.forEach((tier) => {
          const tierDiv = document.createElement("div");
          tierDiv.classList.add("tier-item");

          let qtyString =
            tier.min === tier.max
              ? `${tier.min} Item${tier.min > 1 ? "s" : ""}`
              : tier.max === Infinity
              ? `${tier.min}+ Items`
              : `${tier.min}-${tier.max} Items`;

          if (currentQty >= tier.min && currentQty <= tier.max) {
            tierDiv.classList.add("current-tier");
          }

          tierDiv.innerHTML = `
              <span style="display:block; font-weight:bold; color:#555;">${qtyString}</span>
              <span class="tier-discount">${(tier.percent * 100).toFixed(
                0
              )}% Off</span>
          `;
          tiersListEl.appendChild(tierDiv);
        });
      }

      function renderCartItems() {
        const cartItems = loadCartFromLocalStorage();
        cartItemsList.innerHTML = "";

        if (cartItems.length === 0) {
          cartItemsList.innerHTML =
            "<p class='empty-cart-message'>Your cart is empty.</p>";
          document.getElementById("cart-summary").style.display = "none";
          discountTiersContainer.style.display = "none";
        } else {
          document.getElementById("cart-summary").style.display = "block";
          discountTiersContainer.style.display = "block";

          cartItems.forEach((item, index) => {
            const li = document.createElement("li");
            li.className = "cart-item";

            // Ê†∏ÂøÉÈÄªËæëÔºöÂ±ïÁ§∫ÂìÅÁâåÂêç
            // 1. Â∞ùËØï‰ΩøÁî® item.brand (Â¶ÇÊûú index.html ‰øùÂ≠ò‰∫Ü)
            // 2. Â¶ÇÊûúÊ≤°ÊúâÔºåÂ∞ùËØïÂéªÂÖ®Â±Ä db.js ÈáåÊ†πÊçÆ ID Êü•Êâæ
            let displayName = item.brand;

            if (!displayName && window.perfumeDB) {
              const dbItem = window.perfumeDB.find((p) => p.id === item.name);
              if (dbItem && dbItem.brand) {
                displayName = dbItem.brand;
              }
            }

            // 3. ÊúÄÂêéÁöÑÂÖúÂ∫ïÔºöÂ¶ÇÊûúËøòÊòØÊâæ‰∏çÂà∞ÔºåÂ∞±Âè™ÊòæÁ§∫ ID ÂêéÁöÑÁ¨¨‰∏ÄÊÆµ
            if (!displayName) {
              displayName = getShortCaption(item.caption);
            }

            li.innerHTML = `
              <img src="${item.img}" alt="${item.name}">
              <div class="item-details">
                <h3>${displayName}</h3>
                <div style="font-size: 0.85rem; color: #666; margin-bottom: 4px;">
                    ${item.ml ? item.ml + "ml" : ""} ${
              item.floz ? "/ " + item.floz + " FL.OZ" : ""
            }
                </div>
                <p>Price: $${item.price}</p>
                <div class="quantity-control">
                  <button class="decrease-quantity" data-index="${index}">-</button>
                  <span>${item.quantity}</span>
                  <button class="increase-quantity" data-index="${index}">+</button>
                </div>
              </div>
              <button class="remove-btn" data-index="${index}">Remove</button>
            `;
            cartItemsList.appendChild(li);
          });
        }
        updateCartSummary();
      }

      function updateCartSummary() {
        let cartItems = loadCartFromLocalStorage();
        let totalCount = 0;
        let subtotal = 0;

        cartItems.forEach((item) => {
          totalCount += item.quantity;
          subtotal += (item.price || 0) * item.quantity;
        });

        let discountPercent = 0;
        const currentTier = tiers.find(
          (t) => totalCount >= t.min && totalCount <= t.max
        );
        if (currentTier) discountPercent = currentTier.percent;

        const finalTotal = Math.round(subtotal * (1 - discountPercent));
        const discountAmount = subtotal - finalTotal;

        totalCountEl.textContent = totalCount;
        subtotalPriceEl.textContent = `$${subtotal.toFixed(2)}`;
        discountAmountEl.textContent = `-$${discountAmount.toFixed(2)} (${(
          discountPercent * 100
        ).toFixed(0)}%)`;
        totalPriceEl.textContent = `$${finalTotal.toFixed(2)}`;

        // Update Visual Tiers
        renderDiscountTiers(totalCount);

        return { totalCount, subtotal, discountAmount, finalTotal };
      }

      cartItemsList.addEventListener("click", (e) => {
        const index = e.target.getAttribute("data-index");
        if (index === null) return;
        let cartItems = loadCartFromLocalStorage();

        if (e.target.classList.contains("remove-btn")) {
          cartItems.splice(index, 1);
        } else if (e.target.classList.contains("increase-quantity")) {
          cartItems[index].quantity++;
        } else if (e.target.classList.contains("decrease-quantity")) {
          cartItems[index].quantity = Math.max(
            0,
            cartItems[index].quantity - 1
          );
          if (cartItems[index].quantity === 0) cartItems.splice(index, 1);
        }
        saveCartToLocalStorage(cartItems);
        renderCartItems();
      });

      clearCartBtn.addEventListener("click", () => {
        if (confirm("Clear cart?")) {
          localStorage.removeItem("perfumeCart");
          renderCartItems();
        }
      });

      // Modal Logic
      sendWhatsappBtn.addEventListener("click", () => {
        const cartItems = loadCartFromLocalStorage();
        if (cartItems.length === 0) {
          alert("Cart is empty.");
          return;
        }

        if (typeof fbq !== "undefined") {
          const summary = updateCartSummary();
          fbq("track", "InitiateCheckout", {
            num_items: summary.totalCount,
            value: summary.finalTotal,
            currency: "USD",
          });
        }
        checkoutModal.classList.add("open");
      });

      closeCheckoutBtn.addEventListener("click", () =>
        checkoutModal.classList.remove("open")
      );

      checkoutForm.addEventListener("submit", (e) => {
        e.preventDefault();

        const name = document.getElementById("cust-name").value;
        const email = document.getElementById("cust-email").value;
        const address = document.getElementById("cust-address").value;
        const city = document.getElementById("cust-city").value;
        const zip = document.getElementById("cust-zip").value;
        const trackerID = localStorage.getItem("ga_client_id") || "Unknown";

        const cartItems = loadCartFromLocalStorage();
        const summary = updateCartSummary();

        const messageLines = cartItems.map(
          (item) => `* ${getShortCaption(item.caption)} (x${item.quantity})`
        );

        const message = [
          `*üÜï NEW ORDER REQUEST*`,
          `----------------`,
          `*üë§ Customer Info:*`,
          `Name: ${name}`,
          `Email: ${email}`,
          `Address: ${address}, ${city}, ${zip}`,
          `----------------`,
          `*üõí Order Details:*`,
          ...messageLines,
          `----------------`,
          `Total Qty: ${summary.totalCount}`,
          `Subtotal: $${summary.subtotal.toFixed(2)}`,
          `Discount: -$${summary.discountAmount.toFixed(2)}`,
          `*EST. TOTAL: $${summary.finalTotal.toFixed(2)}*`,
          `----------------`,
          `Ref ID: ${trackerID}`,
          `----------------`,
          `Please confirm shipping cost and availability.`,
        ].join("%0A");

        if (typeof fbq !== "undefined") {
          fbq("track", "Purchase", {
            value: summary.finalTotal,
            currency: "USD",
            num_items: summary.totalCount,
            content_type: "product",
          });
        }
        if (typeof gtag !== "undefined") {
          gtag("event", "purchase", {
            transaction_id: trackerID + "-" + Date.now(),
            value: summary.finalTotal,
            currency: "USD",
            items: cartItems.map((item) => ({
              item_id: item.name,
              price: item.price,
              quantity: item.quantity,
            })),
          });
        }

        const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${message}`;
        window.open(whatsappUrl, "_blank");
        checkoutModal.classList.remove("open");
      });

      document.addEventListener("DOMContentLoaded", renderCartItems);
    </script>
  </body>
</html>
