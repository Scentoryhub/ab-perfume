<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Your Cart</title>
    <link rel="icon" type="image/png" href="icon/32.png" />
    <link rel="apple-touch-icon" href="icon/180.png" />

    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-ZKERETN8Y2"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-ZKERETN8Y2", {
        custom_map: { dimension1: "client_id" },
      });
      gtag("get", "G-ZKERETN8Y2", "client_id", (clientID) => {
        localStorage.setItem("ga_client_id", clientID);
      });
    </script>

    <script>
      !(function (f, b, e, v, n, t, s) {
        if (f.fbq) return;
        n = f.fbq = function () {
          n.callMethod
            ? n.callMethod.apply(n, arguments)
            : n.queue.push(arguments);
        };
        if (!f._fbq) f._fbq = n;
        n.push = n;
        n.loaded = !0;
        n.version = "2.0";
        n.queue = [];
        t = b.createElement(e);
        t.async = !0;
        t.src = v;
        s = b.getElementsByTagName(e)[0];
        s.parentNode.insertBefore(t, s);
      })(
        window,
        document,
        "script",
        "https://connect.facebook.net/en_US/fbevents.js"
      );
      fbq("init", "9083739771684521");
      fbq("track", "PageView");
    </script>
    <noscript
      ><img
        height="1"
        width="1"
        style="display: none"
        src="https://www.facebook.com/tr?id=9083739771684521&ev=PageView&noscript=1"
    /></noscript>
    <style>
      /* Reset and common styles */
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        padding: 0;
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        background: #f4f4f4;
        color: #222;
        -webkit-font-smoothing: antialiased;
        padding-bottom: 140px;
      }
      .page-header {
        background-color: #fff;
        padding: 20px;
        text-align: center;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }
      .page-header h1 {
        margin: 0;
        font-size: 1.6rem;
        font-weight: 800;
      }
      .back-btn {
        position: absolute;
        top: 22px;
        left: 20px;
        width: 24px;
        height: 24px;
        background-image: url("icon/back.png");
        background-size: contain;
        cursor: pointer;
      }

      #capture-area {
        max-width: 800px; /* ÈªòËÆ§Á™Ñ‰∏ÄÁÇπÔºåÈÄÇÂêàÂçïÂàó */
        margin: 0 auto;
        padding: 0 15px;
        transition: max-width 0.3s ease; /* ÂÆΩÂ∫¶ÂàáÊç¢Âä®Áîª */
      }

      /* --- Product List Layout --- */
      .cart-items-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        gap: 12px;
        grid-template-columns: 1fr; /* ÈªòËÆ§‰∏∫ÂçïÂàó */
      }

      /* * Âä®ÊÄÅÂ∏ÉÂ±ÄÁ±ª (Áî± JS ÊéßÂà∂)
       * ‰ªÖÂú® PC Á´Ø (>768px) ÁîüÊïà
       */
      @media (min-width: 768px) {
        /* ÂèåÂàóÊ®°Âºè */
        .cart-items-list.layout-2col {
          grid-template-columns: 1fr 1fr;
          gap: 15px;
        }
        /* ‰∏âÂàóÊ®°Âºè */
        .cart-items-list.layout-3col {
          grid-template-columns: 1fr 1fr 1fr;
          gap: 15px;
        }
      }

      .cart-item {
        background: #fff;
        border-radius: 10px;
        padding: 15px;
        display: flex;
        align-items: center;
        gap: 15px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        position: relative;
      }

      .cart-item img {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 6px;
        border: 1px solid #eee;
        flex-shrink: 0;
      }

      .item-details {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        min-width: 0;
      }

      .item-details h3 {
        margin: 0 0 4px 0;
        font-size: 1rem;
        font-weight: 800;
        color: #000;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .item-size {
        font-size: 0.75rem;
        color: #777;
        margin-bottom: 4px;
      }

      .item-price {
        font-size: 0.9rem;
        font-weight: 700;
        color: #000;
        margin-bottom: 8px;
      }

      .quantity-control {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .quantity-control button {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: 1px solid #ccc;
        background: #fff;
        cursor: pointer;
        font-weight: bold;
        color: #555;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
      }
      .quantity-control span {
        font-weight: 700;
        font-size: 0.95rem;
        min-width: 15px;
        text-align: center;
      }

      .remove-btn {
        padding: 6px 12px;
        background: #f0f0f0;
        color: #666;
        border: none;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 500;
        cursor: pointer;
      }
      .remove-btn:hover {
        background: #e0e0e0;
      }

      /* --- Summary & Tiers --- */
      .cart-summary {
        background: #fff;
        border-radius: 10px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }
      .cart-summary h2 {
        text-align: center;
        margin-top: 0;
        font-size: 1.2rem;
        margin-bottom: 15px;
      }

      .summary-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 0.95rem;
        color: #333;
      }
      .summary-row.bold {
        font-weight: 700;
        margin-top: 5px;
        margin-bottom: 15px;
      }
      .summary-row.discount {
        color: #28a745;
      }
      .summary-row.total {
        font-size: 1.3rem;
        font-weight: 800;
        border-top: 1px solid #eee;
        padding-top: 15px;
        margin-top: 5px;
        color: #000;
      }

      .discount-tiers-container {
        background: #fff;
        border-radius: 10px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }
      .discount-tiers-container h3 {
        text-align: center;
        margin: 0 0 15px 0;
        font-size: 1.1rem;
      }
      #tiers-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
        gap: 8px;
      }
      .tier-item {
        background: #f9f9f9;
        border: 1px solid #eee;
        border-radius: 5px;
        padding: 8px 5px;
        text-align: center;
        font-size: 0.8rem;
      }
      .tier-item.current-tier {
        background-color: #d4edda;
        border-color: #c3e6cb;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .tier-qty {
        font-weight: bold;
        color: #555;
        display: block;
        margin-bottom: 2px;
      }
      .tier-off {
        font-weight: 800;
        color: #28a745;
        font-size: 0.9rem;
      }

      /* --- Actions --- */
      .cart-actions {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: #fff;
        padding: 15px;
        display: flex;
        gap: 15px;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        z-index: 100;
        justify-content: center;
      }
      .cart-actions button {
        flex: 1;
        max-width: 200px;
        padding: 12px;
        border-radius: 25px;
        border: none;
        font-size: 1rem;
        font-weight: bold;
        cursor: pointer;
      }
      .clear-cart-btn {
        background: #eee;
        color: #555;
      }
      .send-whatsapp-btn {
        background: #25d366;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      /* --- Modal --- */
      .checkout-modal {
        display: none;
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        z-index: 2000;
        align-items: center;
        justify-content: center;
      }
      .checkout-modal.open {
        display: flex;
      }
      .checkout-container {
        background: #fff;
        padding: 25px;
        width: 90%;
        max-width: 500px;
        border-radius: 12px;
        max-height: 90vh;
        overflow-y: auto;
      }
      .form-group {
        margin-bottom: 15px;
      }
      .form-group label {
        display: block;
        font-weight: bold;
        margin-bottom: 5px;
      }
      .form-group input,
      .form-group textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
      }
      .checkout-btn-group {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }
      .cancel-btn,
      .confirm-btn {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 6px;
        font-weight: bold;
        cursor: pointer;
      }
      .cancel-btn {
        background: #eee;
      }
      .confirm-btn {
        background: #25d366;
        color: white;
      }

      .empty-cart-container {
        text-align: center;
        padding: 60px 0;
      }
      .continue-shopping-btn {
        display: inline-block;
        background: #333;
        color: white;
        padding: 10px 25px;
        border-radius: 20px;
        text-decoration: none;
        font-weight: bold;
        margin-top: 15px;
      }
    </style>
  </head>
  <body>
    <header class="page-header">
      <a href="index.html" class="back-btn" aria-label="Go back"></a>
      <h1>Your Cart</h1>
    </header>

    <div id="capture-area">
      <ul id="cart-items-list" class="cart-items-list"></ul>

      <div id="cart-summary" class="cart-summary" style="display: none">
        <h2>Order Summary</h2>
        <div class="summary-row">
          <span>LV Quantity:</span><span id="lv-count">0</span>
        </div>
        <div class="summary-row">
          <span>Other Brands Quantity:</span><span id="other-count">0</span>
        </div>
        <div class="summary-row bold">
          <span>Total Quantity:</span><span id="total-count">0</span>
        </div>
        <div class="summary-row">
          <span>Subtotal (Original Price):</span
          ><span id="subtotal-price">$0.00</span>
        </div>
        <div class="summary-row discount">
          <span>Volume Discount:</span><span id="discount-amount">-$0.00</span>
        </div>
        <div class="summary-row total">
          <span>Total Price:</span><span id="total-price">$0.00</span>
        </div>
      </div>

      <div
        id="discount-tiers"
        class="discount-tiers-container"
        style="display: none"
      >
        <h3>Volume Discounts</h3>
        <div id="tiers-list"></div>
      </div>
    </div>

    <div class="cart-actions" id="cart-actions" style="display: none">
      <button id="clear-cart-btn" class="clear-cart-btn">Clear Cart</button>
      <button id="send-whatsapp-btn" class="send-whatsapp-btn">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 90 90"
          width="18"
          height="18"
          fill="currentColor"
        >
          <path
            d="M90,43.841c0,24.213-19.779,43.841-44.182,43.841c-7.747,0-15.025-1.98-21.357-5.455L0,90l7.975-23.522   c-4.023-6.606-6.34-14.354-6.34-22.637C1.635,19.628,21.416,0,45.818,0C70.223,0,90,19.628,90,43.841z M45.818,6.982   c-20.484,0-37.146,16.535-37.146,36.859c0,8.065,2.629,15.534,7.076,21.61L11.107,79.14l14.275-4.537   c5.865,3.851,12.891,6.097,20.437,6.097c20.481,0,37.146-16.533,37.146-36.857S66.301,6.982,45.818,6.982z M68.129,53.938   c-0.273-0.447-0.994-0.717-2.076-1.254c-1.084-0.537-6.41-3.138-7.4-3.495c-0.993-0.358-1.714-0.538-2.438,0.537   c-0.721,1.076-2.797,3.495-3.43,4.212c-0.632,0.719-1.263,0.809-2.347,0.271c-1.082-0.537-4.571-1.673-8.708-5.333   c-3.219-2.848-5.393-6.364-6.025-7.441c-0.631-1.075-0.066-1.656,0.475-2.191c0.488-0.482,1.084-1.255,1.625-1.882   c0.543-0.628,0.723-1.075,1.082-1.793c0.363-0.717,0.182-1.344-0.09-1.883c-0.27-0.537-2.438-5.825-3.34-8.001   c-0.877-2.129-1.758-1.839-2.438-1.839c-0.631,0-1.354-0.09-2.076-0.09c-0.722,0-1.896,0.269-2.889,1.344   c-0.992,1.076-3.789,3.676-3.789,8.963c0,5.288,3.879,10.397,4.422,11.113c0.541,0.716,7.49,11.381,18.17,15.996   c7.31,3.199,9.75,2.56,11.5,2.379c2.471-0.252,6.41-2.604,7.31-5.187C68.4,55.619,68.4,54.386,68.129,53.938z"
          />
        </svg>
        <span>Make Order Now</span>
      </button>
    </div>

    <div id="checkout-modal" class="checkout-modal">
      <div class="checkout-container">
        <div
          style="
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
          "
        >
          <h2 style="margin: 0">Shipping Details</h2>
          <p style="color: #666; font-size: 0.9rem">
            Please enter your address to calculate shipping.
          </p>
        </div>
        <form id="checkout-form">
          <div class="form-group">
            <label>Full Name *</label
            ><input type="text" id="cust-name" required />
          </div>
          <div class="form-group">
            <label>Email Address *</label
            ><input type="email" id="cust-email" required />
          </div>
          <div class="form-group">
            <label>Street Address *</label
            ><textarea id="cust-address" rows="2" required></textarea>
          </div>
          <div style="display: flex; gap: 10px">
            <div class="form-group" style="flex: 1">
              <label>City *</label><input type="text" id="cust-city" required />
            </div>
            <div class="form-group" style="flex: 1">
              <label>Zip Code *</label
              ><input type="text" id="cust-zip" required />
            </div>
          </div>
          <div class="checkout-btn-group">
            <button type="button" class="cancel-btn" id="close-checkout">
              Cancel
            </button>
            <button type="submit" class="confirm-btn">Confirm & Send</button>
          </div>
        </form>
      </div>
    </div>

    <script src="db.js"></script>
    <script>
      // --- Logic ---
      const cartItemsList = document.getElementById("cart-items-list");
      const captureArea = document.getElementById("capture-area"); // ÂÆπÂô®
      const clearCartBtn = document.getElementById("clear-cart-btn");
      const sendWhatsappBtn = document.getElementById("send-whatsapp-btn");
      const cartActions = document.getElementById("cart-actions");

      // Summary Elements
      const lvCountEl = document.getElementById("lv-count");
      const otherCountEl = document.getElementById("other-count");
      const totalCountEl = document.getElementById("total-count");
      const subtotalPriceEl = document.getElementById("subtotal-price");
      const discountAmountEl = document.getElementById("discount-amount");
      const totalPriceEl = document.getElementById("total-price");

      const tiersListEl = document.getElementById("tiers-list");
      const discountTiersContainer = document.getElementById("discount-tiers");
      const cartSummaryContainer = document.getElementById("cart-summary");

      const checkoutModal = document.getElementById("checkout-modal");
      const checkoutForm = document.getElementById("checkout-form");
      const closeCheckoutBtn = document.getElementById("close-checkout");

      const whatsappNumber = "16232027321";

      // Tiers
      const tiers = [
        { min: 1, max: 1, percent: 0 },
        { min: 2, max: 2, percent: 0.03 },
        { min: 3, max: 4, percent: 0.05 },
        { min: 5, max: 9, percent: 0.08 },
        { min: 10, max: 19, percent: 0.14 },
        { min: 20, max: 29, percent: 0.24 },
        { min: 30, max: 49, percent: 0.26 },
        { min: 50, max: 79, percent: 0.29 },
        { min: 80, max: 100, percent: 0.32 },
        { min: 101, max: Infinity, percent: 0.35 },
      ];

      function loadCartFromLocalStorage() {
        const storedCart = localStorage.getItem("perfumeCart");
        return storedCart ? JSON.parse(storedCart) : [];
      }
      function saveCartToLocalStorage(cart) {
        localStorage.setItem("perfumeCart", JSON.stringify(cart));
      }
      function getShortCaption(fullCaption) {
        return fullCaption.split(" - ").slice(0, 2).join(" - ");
      }

      // Discount Tiers
      function renderDiscountTiers(currentQty) {
        if (!tiersListEl) return;
        tiersListEl.innerHTML = "";
        tiers.forEach((tier) => {
          const tierDiv = document.createElement("div");
          tierDiv.classList.add("tier-item");
          let qtyString =
            tier.min === tier.max
              ? `${tier.min} Item`
              : tier.max === Infinity
              ? `${tier.min}+ Items`
              : `${tier.min}-${tier.max} Items`;
          if (currentQty >= tier.min && currentQty <= tier.max)
            tierDiv.classList.add("current-tier");
          tierDiv.innerHTML = `<span class="tier-qty">${qtyString}</span><span class="tier-off">${(
            tier.percent * 100
          ).toFixed(0)}% Off</span>`;
          tiersListEl.appendChild(tierDiv);
        });
      }

      // Smart Layout Adjustment Function (Êô∫ËÉΩÂ∏ÉÂ±ÄË∞ÉÊï¥)
      function updateLayoutMode(itemCount) {
        const isPC = window.innerWidth >= 768;

        // Ê∏ÖÈô§ÊâÄÊúâÂ∏ÉÂ±ÄÁ±ª
        cartItemsList.classList.remove("layout-2col", "layout-3col");
        captureArea.style.maxWidth = "1100px"; // ÈªòËÆ§ÂÆΩÂ∫¶

        if (!isPC) return; // ÊâãÊú∫Á´Ø‰øùÊåÅÈªòËÆ§CSS (1Âàó)

        // PCÁ´ØÈÄªËæëÔºöÊ†πÊçÆ‰∫ßÂìÅÊï∞ÈáèÊô∫ËÉΩÂàáÊç¢
        if (itemCount < 5) {
          // Â∞ë‰∫é5‰∏™Ôºö‰øùÊåÅÂçïÂàóÔºå‰ΩÜÂç°ÁâáÂÆΩ‰∏ÄÁÇπ
          captureArea.style.maxWidth = "800px";
        } else if (itemCount <= 10) {
          // 5-10‰∏™ÔºöÂèåÂàó
          cartItemsList.classList.add("layout-2col");
          captureArea.style.maxWidth = "1100px";
        } else {
          // 10‰∏™‰ª•‰∏äÔºö‰∏âÂàó (Â¶ÇÊûúÂ±èÂπïÂ§üÂ§ß)
          if (window.innerWidth >= 1200) {
            cartItemsList.classList.add("layout-3col");
            captureArea.style.maxWidth = "1400px"; // ÊãìÂÆΩÂÆπÂô®
          } else {
            // Â±èÂπï‰∏çÂ§üÂ§ßÔºåÂº∫Âà∂ÂèåÂàó
            cartItemsList.classList.add("layout-2col");
          }
        }
      }

      function renderCartItems() {
        const cartItems = loadCartFromLocalStorage();
        cartItemsList.innerHTML = "";

        // Ë∞ÉÁî®Êô∫ËÉΩÂ∏ÉÂ±Ä
        updateLayoutMode(cartItems.length);

        if (cartItems.length === 0) {
          cartItemsList.innerHTML = `<div class="empty-cart-container"><p class='empty-cart-message'>Your cart is empty.</p><a href="index.html" class="continue-shopping-btn">Continue Shopping</a></div>`;
          cartSummaryContainer.style.display = "none";
          discountTiersContainer.style.display = "none";
          cartActions.style.display = "none";
        } else {
          cartSummaryContainer.style.display = "block";
          discountTiersContainer.style.display = "block";
          cartActions.style.display = "flex";

          cartItems.forEach((item, index) => {
            const li = document.createElement("li");
            li.className = "cart-item";

            let displayName = item.brand;
            if (!displayName && window.perfumeDB) {
              const dbItem = window.perfumeDB.find((p) => p.id === item.name);
              if (dbItem && dbItem.brand) displayName = dbItem.brand;
            }
            if (!displayName) displayName = getShortCaption(item.caption);

            const titleText = `${item.name} - ${displayName}`;

            li.innerHTML = `
              <img src="${item.img}" alt="${item.name}">
              <div class="item-details">
                <h3>${titleText}</h3>
                <div class="item-size">${item.ml ? item.ml + "ml" : ""} ${
              item.floz ? "/ " + item.floz + " FL.OZ" : ""
            }</div>
                <div class="item-price">Original Price: $${item.price}</div>
                <div class="quantity-control">
                  <button class="decrease-quantity" data-index="${index}">-</button>
                  <span>${item.quantity}</span>
                  <button class="increase-quantity" data-index="${index}">+</button>
                </div>
              </div>
              <button class="remove-btn" data-index="${index}">Remove</button>
            `;
            cartItemsList.appendChild(li);
          });
        }
        updateCartSummary();
      }

      function updateCartSummary() {
        let cartItems = loadCartFromLocalStorage();
        let totalCount = 0;
        let subtotal = 0;
        let lvCount = 0;

        cartItems.forEach((item) => {
          const qty = item.quantity;
          totalCount += qty;
          subtotal += (item.price || 0) * qty;

          let brandName = item.brand || "";
          if (!brandName && window.perfumeDB) {
            const dbItem = window.perfumeDB.find((p) => p.id === item.name);
            if (dbItem) brandName = dbItem.brand || "";
          }
          if (!brandName) brandName = item.caption || "";

          if (
            brandName.toLowerCase().includes("louis vuitton") ||
            brandName.toLowerCase().includes("lv")
          ) {
            lvCount += qty;
          }
        });

        let otherCount = totalCount - lvCount;
        let discountPercent = 0;
        const currentTier = tiers.find(
          (t) => totalCount >= t.min && totalCount <= t.max
        );
        if (currentTier) discountPercent = currentTier.percent;

        const finalTotal = Math.round(subtotal * (1 - discountPercent));
        const discountAmount = subtotal - finalTotal;

        lvCountEl.textContent = lvCount;
        otherCountEl.textContent = otherCount;
        totalCountEl.textContent = totalCount;
        subtotalPriceEl.textContent = `$${subtotal.toFixed(2)}`;
        discountAmountEl.textContent = `-$${discountAmount.toFixed(2)} (${(
          discountPercent * 100
        ).toFixed(0)}% off)`;
        totalPriceEl.textContent = `$${finalTotal.toFixed(2)}`;

        renderDiscountTiers(totalCount);
        return {
          totalCount,
          subtotal,
          discountAmount,
          finalTotal,
          lvCount,
          otherCount,
        };
      }

      // Listeners
      cartItemsList.addEventListener("click", (e) => {
        const index = e.target.getAttribute("data-index");
        if (index === null) return;
        let cartItems = loadCartFromLocalStorage();

        if (e.target.classList.contains("remove-btn")) {
          cartItems.splice(index, 1);
        } else if (e.target.classList.contains("increase-quantity")) {
          cartItems[index].quantity++;
        } else if (e.target.classList.contains("decrease-quantity")) {
          cartItems[index].quantity = Math.max(
            0,
            cartItems[index].quantity - 1
          );
          if (cartItems[index].quantity === 0) cartItems.splice(index, 1);
        }
        saveCartToLocalStorage(cartItems);
        renderCartItems();
      });

      clearCartBtn.addEventListener("click", () => {
        if (confirm("Clear cart?")) {
          localStorage.removeItem("perfumeCart");
          renderCartItems();
        }
      });

      sendWhatsappBtn.addEventListener("click", () => {
        const cartItems = loadCartFromLocalStorage();
        if (cartItems.length === 0) {
          alert("Cart is empty.");
          return;
        }
        if (typeof fbq !== "undefined") {
          const summary = updateCartSummary();
          fbq("track", "InitiateCheckout", {
            num_items: summary.totalCount,
            value: summary.finalTotal,
            currency: "USD",
          });
        }
        checkoutModal.classList.add("open");
      });

      closeCheckoutBtn.addEventListener("click", () =>
        checkoutModal.classList.remove("open")
      );

      checkoutForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const name = document.getElementById("cust-name").value;
        const email = document.getElementById("cust-email").value;
        const address = document.getElementById("cust-address").value;
        const city = document.getElementById("cust-city").value;
        const zip = document.getElementById("cust-zip").value;
        const trackerID = localStorage.getItem("ga_client_id") || "Unknown";
        const cartItems = loadCartFromLocalStorage();
        const summary = updateCartSummary();

        const messageLines = cartItems.map((item) => {
          let brand = item.brand;
          if (!brand && window.perfumeDB) {
            const dbItem = window.perfumeDB.find((p) => p.id === item.name);
            if (dbItem) brand = dbItem.brand;
          }
          if (!brand) brand = getShortCaption(item.caption);
          return `* ${item.name} - ${brand} (x${item.quantity})`;
        });

        const message = [
          `*üÜï NEW ORDER REQUEST*`,
          `----------------`,
          `*üë§ Customer Info:*`,
          `Name: ${name}`,
          `Email: ${email}`,
          `Address: ${address}, ${city}, ${zip}`,
          `----------------`,
          `*üõí Order Details:*`,
          ...messageLines,
          `----------------`,
          `LV Qty: ${summary.lvCount}`,
          `Other Brands Qty: ${summary.otherCount}`,
          `*Total Qty: ${summary.totalCount}*`,
          `Subtotal: $${summary.subtotal.toFixed(2)}`,
          `Discount: -$${summary.discountAmount.toFixed(2)}`,
          `*EST. TOTAL: $${summary.finalTotal.toFixed(2)}*`,
          `----------------`,
          `Ref ID: ${trackerID}`,
          `----------------`,
          `Please confirm shipping cost and availability.`,
        ].join("%0A");

        if (typeof fbq !== "undefined") {
          fbq("track", "Purchase", {
            value: summary.finalTotal,
            currency: "USD",
            num_items: summary.totalCount,
            content_type: "product",
          });
        }
        if (typeof gtag !== "undefined") {
          gtag("event", "purchase", {
            transaction_id: trackerID + "-" + Date.now(),
            value: summary.finalTotal,
            currency: "USD",
            items: cartItems.map((item) => ({
              item_id: item.name,
              price: item.price,
              quantity: item.quantity,
            })),
          });
        }

        const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${message}`;
        window.open(whatsappUrl, "_blank");
        checkoutModal.classList.remove("open");
      });

      window.addEventListener("resize", () => {
        renderCartItems();
      }); // Resize Ëß¶ÂèëÈáçÊñ∞Â∏ÉÂ±Ä
      document.addEventListener("DOMContentLoaded", renderCartItems);
    </script>
  </body>
</html>
