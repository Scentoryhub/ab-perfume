<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Your Cart</title>
    <link rel="icon" type="image/png" href="icon/32.png" />
    <link rel="apple-touch-icon" href="icon/180.png" />

    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-ZKERETN8Y2"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      // æå– Client ID
      gtag("config", "G-ZKERETN8Y2", {
        custom_map: { dimension1: "client_id" },
      });
      gtag("get", "G-ZKERETN8Y2", "client_id", (clientID) => {
        localStorage.setItem("ga_client_id", clientID);
      });
    </script>

    <script>
      !(function (f, b, e, v, n, t, s) {
        if (f.fbq) return;
        n = f.fbq = function () {
          n.callMethod
            ? n.callMethod.apply(n, arguments)
            : n.queue.push(arguments);
        };
        if (!f._fbq) f._fbq = n;
        n.push = n;
        n.loaded = !0;
        n.version = "2.0";
        n.queue = [];
        t = b.createElement(e);
        t.async = !0;
        t.src = v;
        s = b.getElementsByTagName(e)[0];
        s.parentNode.insertBefore(t, s);
      })(
        window,
        document,
        "script",
        "https://connect.facebook.net/en_US/fbevents.js"
      );
      fbq("init", "9083739771684521");
      fbq("track", "PageView");
    </script>
    <noscript
      ><img
        height="1"
        width="1"
        style="display: none"
        src="https://www.facebook.com/tr?id=9083739771684521&ev=PageView&noscript=1"
    /></noscript>
    <style>
      /* Basic Reset */
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        padding: 0;
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        background: #f4f4f4;
        color: #111;
        padding-bottom: 120px;
      }
      .page-header {
        position: relative;
        text-align: center;
        padding: 20px 15px;
        border-bottom: 1px solid #eee;
        background-color: #fff;
        margin-bottom: 20px;
      }
      .page-header h1 {
        margin: 0;
        font-size: 1.8rem;
        font-weight: 700;
        color: #222;
      }
      .back-btn {
        position: absolute;
        top: 50%;
        left: 15px;
        transform: translateY(-50%);
        width: 30px;
        height: 30px;
        cursor: pointer;
        background-image: url("icon/back.png");
        background-size: contain;
        background-repeat: no-repeat;
      }

      /* Cart List */
      #capture-area {
        max-width: 1200px;
        margin: 0 auto;
        padding: 15px;
      }
      .cart-items-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        grid-template-columns: 1fr;
        gap: 15px;
      }
      @media (min-width: 768px) {
        .cart-items-list {
          grid-template-columns: 1fr 1fr;
        }
      }
      .cart-item {
        display: flex;
        align-items: center;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        overflow: hidden;
        gap: 15px;
        padding-right: 15px;
      }
      .cart-item img {
        width: 80px;
        height: 80px;
        object-fit: cover;
        flex-shrink: 0;
      }
      .item-details {
        flex-grow: 1;
        padding: 15px 0;
      }
      .item-details h3 {
        margin: 0 0 5px 0;
        font-size: 1.1rem;
        color: #333;
      }
      .quantity-control {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 5px;
      }
      .quantity-control button {
        background: #f0f0f0;
        border: 1px solid #ccc;
        border-radius: 50%;
        width: 25px;
        height: 25px;
        cursor: pointer;
      }
      .remove-btn {
        padding: 6px 10px;
        background: #eee;
        color: #777;
        border: 1px solid #ddd;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.8rem;
        margin-left: auto;
      }

      /* Summary */
      .cart-summary {
        margin: 20px 0 0 0;
        padding: 20px;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }
      .cart-summary p {
        display: flex;
        justify-content: space-between;
        margin: 8px 0;
        font-size: 1.1rem;
      }
      .total-count {
        font-weight: bold;
        font-size: 1.2rem;
      }

      /* Footer Actions */
      .cart-actions {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background-color: #fff;
        padding: 15px;
        display: flex;
        justify-content: center;
        gap: 10px;
        border-top: 1px solid #eee;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        z-index: 10;
      }
      .cart-actions button {
        padding: 12px 15px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: bold;
        flex-grow: 1;
        max-width: 220px;
      }
      .clear-cart-btn {
        background-color: #e7e7e7;
        color: #555;
      }
      .send-whatsapp-btn {
        background-color: #25d366;
        color: white;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      /* === CHECKOUT MODAL STYLES === */
      .checkout-modal {
        display: none;
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        align-items: center;
        justify-content: center;
      }
      .checkout-modal.open {
        display: flex;
      }
      .checkout-container {
        background: #fff;
        width: 90%;
        max-width: 500px;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
      }
      .checkout-header {
        text-align: center;
        margin-bottom: 20px;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
      }
      .form-group {
        margin-bottom: 15px;
        text-align: left;
      }
      .form-group label {
        display: block;
        font-weight: bold;
        margin-bottom: 5px;
        font-size: 0.9rem;
      }
      .form-group input,
      .form-group textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 1rem;
      }
      .checkout-btn-group {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }
      .cancel-btn {
        flex: 1;
        background: #eee;
        border: none;
        padding: 12px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
      }
      .confirm-btn {
        flex: 2;
        background: #25d366;
        color: white;
        border: none;
        padding: 12px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
      }

      .empty-cart-message {
        text-align: center;
        color: #777;
        font-size: 1.1rem;
        padding: 50px 0;
      }
    </style>
  </head>
  <body>
    <header class="page-header">
      <a href="index.html" class="back-btn" aria-label="Go back"></a>
      <h1>Your Cart</h1>
    </header>

    <div id="capture-area">
      <ul id="cart-items-list" class="cart-items-list"></ul>
      <div id="cart-summary" class="cart-summary">
        <h2>Order Summary</h2>
        <p><span>Total Quantity:</span> <span id="total-count">0</span></p>
        <p><span>Subtotal:</span> <span id="subtotal-price">$0.00</span></p>
        <p style="color: #28a745">
          <span>Volume Discount:</span> <span id="discount-amount">-$0.00</span>
        </p>
        <p class="total-count" style="font-size: 1.3rem">
          <span>Total Price:</span> <span id="total-price">$0.00</span>
        </p>
      </div>
    </div>

    <div class="cart-actions">
      <button id="clear-cart-btn" class="clear-cart-btn">Clear Cart</button>
      <button id="send-whatsapp-btn" class="send-whatsapp-btn">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="18"
          height="18"
          viewBox="0 0 24 24"
          fill="currentColor"
        >
          <path
            d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-8.683-2.031-.967-.272-.297-.471-.445-.669.546-.198.991-.768.966-.941 1.165-.173.198-1.254.495-2.396 1.464-.881.85-1.476 1.743-1.723 2.04-.248.297-.089.458.06.606.134.133.297.347.446.52.149.174.198.297.297.495.099.198.05.371-.025.52-.075.149-.669 1.612-.916 2.207-.242.579-.487.5-.669.51a12.8 12.8 0 0 1-1.427-.005c-.496 0-1.307.186-1.99.93-1.074 1.171-1.074 4.805 1.536 7.643.648.705 3.018 3.224 7.641 4.312 2.946.689 3.821.571 5.176.438.966-.095 2.505-1.025 2.857-2.015.352-.99.352-1.838.248-2.015z"
          />
        </svg>
        <span>Send Order</span>
      </button>
    </div>

    <div id="checkout-modal" class="checkout-modal">
      <div class="checkout-container">
        <div class="checkout-header">
          <h2>Shipping Details</h2>
          <p style="font-size: 0.9rem; color: #666">
            Please fill in your address to calculate shipping.
          </p>
        </div>

        <form id="checkout-form">
          <div class="form-group">
            <label>Full Name *</label>
            <input type="text" id="cust-name" placeholder="John Doe" required />
          </div>

          <div class="form-group">
            <label>Email Address *</label>
            <input
              type="email"
              id="cust-email"
              placeholder="john@example.com"
              required
            />
          </div>

          <div class="form-group">
            <label>Street Address *</label>
            <textarea
              id="cust-address"
              rows="2"
              placeholder="123 Main St, Apt 4B"
              required
            ></textarea>
          </div>

          <div style="display: flex; gap: 10px">
            <div class="form-group" style="flex: 1">
              <label>City *</label>
              <input
                type="text"
                id="cust-city"
                placeholder="New York"
                required
              />
            </div>
            <div class="form-group" style="flex: 1">
              <label>Zip Code *</label>
              <input type="text" id="cust-zip" placeholder="10001" required />
            </div>
          </div>

          <div class="checkout-btn-group">
            <button type="button" class="cancel-btn" id="close-checkout">
              Cancel
            </button>
            <button type="submit" class="confirm-btn">
              Confirm & Send (WhatsApp)
            </button>
          </div>
        </form>
      </div>
    </div>

    <script src="db.js"></script>
    <script>
      // =================================================================
      // CART LOGIC
      // =================================================================
      const cartItemsList = document.getElementById("cart-items-list");
      const clearCartBtn = document.getElementById("clear-cart-btn");
      const sendWhatsappBtn = document.getElementById("send-whatsapp-btn");

      const totalCountEl = document.getElementById("total-count");
      const subtotalPriceEl = document.getElementById("subtotal-price");
      const discountAmountEl = document.getElementById("discount-amount");
      const totalPriceEl = document.getElementById("total-price");

      const checkoutModal = document.getElementById("checkout-modal");
      const checkoutForm = document.getElementById("checkout-form");
      const closeCheckoutBtn = document.getElementById("close-checkout");

      const whatsappNumber = "16232027321";

      const tiers = [
        { min: 1, max: 1, percent: 0 },
        { min: 2, max: 2, percent: 0.03 },
        { min: 3, max: 4, percent: 0.05 },
        { min: 5, max: 9, percent: 0.08 },
        { min: 10, max: 19, percent: 0.14 },
        { min: 20, max: 29, percent: 0.24 },
        { min: 30, max: 49, percent: 0.26 },
        { min: 50, max: 79, percent: 0.29 },
        { min: 80, max: 100, percent: 0.32 },
        { min: 101, max: Infinity, percent: 0.35 },
      ];

      function loadCartFromLocalStorage() {
        const storedCart = localStorage.getItem("perfumeCart");
        return storedCart ? JSON.parse(storedCart) : [];
      }
      function saveCartToLocalStorage(cart) {
        localStorage.setItem("perfumeCart", JSON.stringify(cart));
      }

      function getShortCaption(fullCaption) {
        // Simple Shortener
        return fullCaption.split(" - ").slice(0, 2).join(" - ");
      }

      function renderCartItems() {
        const cartItems = loadCartFromLocalStorage();
        cartItemsList.innerHTML = "";
        if (cartItems.length === 0) {
          cartItemsList.innerHTML =
            "<p class='empty-cart-message'>Your cart is empty.</p>";
          document.getElementById("cart-summary").style.display = "none";
        } else {
          document.getElementById("cart-summary").style.display = "block";
          cartItems.forEach((item, index) => {
            const li = document.createElement("li");
            li.className = "cart-item";
            li.innerHTML = `
              <img src="${item.img}" alt="${item.name}">
              <div class="item-details">
                <h3>${getShortCaption(item.caption)}</h3>
                <p>Price: $${item.price}</p>
                <div class="quantity-control">
                  <button class="decrease-quantity" data-index="${index}">-</button>
                  <span>${item.quantity}</span>
                  <button class="increase-quantity" data-index="${index}">+</button>
                </div>
              </div>
              <button class="remove-btn" data-index="${index}">Remove</button>
            `;
            cartItemsList.appendChild(li);
          });
        }
        updateCartSummary();
      }

      function updateCartSummary() {
        let cartItems = loadCartFromLocalStorage();
        let totalCount = 0;
        let subtotal = 0;

        cartItems.forEach((item) => {
          totalCount += item.quantity;
          subtotal += (item.price || 0) * item.quantity;
        });

        // Calculate Discount
        let discountPercent = 0;
        const currentTier = tiers.find(
          (t) => totalCount >= t.min && totalCount <= t.max
        );
        if (currentTier) discountPercent = currentTier.percent;

        const finalTotal = Math.round(subtotal * (1 - discountPercent));
        const discountAmount = subtotal - finalTotal;

        totalCountEl.textContent = totalCount;
        subtotalPriceEl.textContent = `$${subtotal.toFixed(2)}`;
        discountAmountEl.textContent = `-$${discountAmount.toFixed(2)} (${(
          discountPercent * 100
        ).toFixed(0)}%)`;
        totalPriceEl.textContent = `$${finalTotal.toFixed(2)}`;

        return { totalCount, subtotal, discountAmount, finalTotal };
      }

      // Event Listeners for Cart Actions
      cartItemsList.addEventListener("click", (e) => {
        const index = e.target.getAttribute("data-index");
        if (index === null) return;
        let cartItems = loadCartFromLocalStorage();

        if (e.target.classList.contains("remove-btn")) {
          cartItems.splice(index, 1);
        } else if (e.target.classList.contains("increase-quantity")) {
          cartItems[index].quantity++;
        } else if (e.target.classList.contains("decrease-quantity")) {
          cartItems[index].quantity = Math.max(
            0,
            cartItems[index].quantity - 1
          );
          if (cartItems[index].quantity === 0) cartItems.splice(index, 1);
        }
        saveCartToLocalStorage(cartItems);
        renderCartItems();
      });

      clearCartBtn.addEventListener("click", () => {
        if (confirm("Clear cart?")) {
          localStorage.removeItem("perfumeCart");
          renderCartItems();
        }
      });

      // === NEW CHECKOUT LOGIC ===

      // 1. Open Modal
      sendWhatsappBtn.addEventListener("click", () => {
        const cartItems = loadCartFromLocalStorage();
        if (cartItems.length === 0) {
          alert("Cart is empty.");
          return;
        }

        // Pixel: InitiateCheckout
        if (typeof fbq !== "undefined") {
          const summary = updateCartSummary();
          fbq("track", "InitiateCheckout", {
            num_items: summary.totalCount,
            value: summary.finalTotal,
            currency: "USD",
          });
        }
        checkoutModal.classList.add("open");
      });

      // 2. Close Modal
      closeCheckoutBtn.addEventListener("click", () =>
        checkoutModal.classList.remove("open")
      );

      // 3. Submit Form & Send WhatsApp
      checkoutForm.addEventListener("submit", (e) => {
        e.preventDefault();

        const name = document.getElementById("cust-name").value;
        const email = document.getElementById("cust-email").value;
        const address = document.getElementById("cust-address").value;
        const city = document.getElementById("cust-city").value;
        const zip = document.getElementById("cust-zip").value;
        const trackerID = localStorage.getItem("ga_client_id") || "Unknown";

        const cartItems = loadCartFromLocalStorage();
        const summary = updateCartSummary();

        const messageLines = cartItems.map(
          (item) => `* ${getShortCaption(item.caption)} (x${item.quantity})`
        );

        const message = [
          `*ðŸ†• NEW ORDER REQUEST*`,
          `----------------`,
          `*ðŸ‘¤ Customer Info:*`,
          `Name: ${name}`,
          `Email: ${email}`,
          `Address: ${address}, ${city}, ${zip}`,
          `----------------`,
          `*ðŸ›’ Order Details:*`,
          ...messageLines,
          `----------------`,
          `Total Qty: ${summary.totalCount}`,
          `Subtotal: $${summary.subtotal.toFixed(2)}`,
          `Discount: -$${summary.discountAmount.toFixed(2)}`,
          `*EST. TOTAL: $${summary.finalTotal.toFixed(2)}*`,
          `----------------`,
          `Ref ID: ${trackerID}`,
          `----------------`,
          `Please confirm shipping cost and availability.`,
        ].join("%0A");

        // TRACKING PURCHASE
        if (typeof fbq !== "undefined") {
          fbq("track", "Purchase", {
            value: summary.finalTotal,
            currency: "USD",
            num_items: summary.totalCount,
            content_type: "product",
          });
        }
        if (typeof gtag !== "undefined") {
          gtag("event", "purchase", {
            transaction_id: trackerID + "-" + Date.now(),
            value: summary.finalTotal,
            currency: "USD",
            items: cartItems.map((item) => ({
              item_id: item.name,
              price: item.price,
              quantity: item.quantity,
            })),
          });
        }

        const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${message}`;
        window.open(whatsappUrl, "_blank");
        checkoutModal.classList.remove("open");
      });

      document.addEventListener("DOMContentLoaded", renderCartItems);
    </script>
  </body>
</html>
